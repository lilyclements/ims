<?xml version="1.0" encoding="UTF-8" ?>

<chapter xml:id="ch22-inference-many-means">
  <title>Inference for comparing many means</title>

<introduction>
  <p>In <xref ref="sec-inference-two-means" /> analysis was done to compare the average population value across two different groups.</p>
  <p>An important aspect of the analysis was to look at the difference in sample means as an estimate for the difference in population means.</p>
  <p>When comparing more than two groups, the difference (i.e., subtraction) will not fully capture the nuance in variation across the three or more groups.</p>
  <p>As with two groups, the research question will focus on whether the group membership is independent of the numerical response variable.</p>
  <p>Here, independence across groups means that knowledge of the observations in one group does not change what we would expect to happen in the other group.</p>
  <p>But what happens if the groups are <term>dependent</term>?</p>
  <p>In this section we focus on a new statistic which incorporates differences in means across more than two groups.</p>
  <p>Although the ideas in this chapter are quite similar to the t-test, they have earned themselves their own name: <term>AN</term>alysis <term>O</term>f <term>VA</term>riance, or ANOVA.</p>
</introduction>

<p>Sometimes we want to compare means across many groups. We might initially think to do pairwise comparisons. For example, if there were three groups, we might be tempted to compare the first mean with the second, then with the third, and then finally compare the second and third means for a total of three comparisons. However, this strategy can be treacherous. If we have many groups and do many comparisons, it is likely that we will eventually find a difference just by chance, even if there is no difference in the populations. Instead, we should apply a holistic test to check whether there is evidence that at least one pair of groups are in fact different, which is where <term>ANOVA</term> saves the day.</p>



<p>In this section, we will learn a new method called <term>analysis of variance (ANOVA)</term> and a new test statistic called an <m>F</m>-statistic (which we will introduce in our discussion of mathematical models). ANOVA uses a single hypothesis test to check whether the means across many groups are equal:</p>


<ul>
  <li><p><m>H_0:</m> The mean outcome is the same across all groups, i.e., <m>\mu_1 = \mu_2 = \cdots = \mu_k</m> where <m>\mu_j</m> represents the mean of the outcome for observations in category <m>j.</m></p></li>
  <li><p><m>H_A:</m> At least one mean is different.</p></li>
</ul>


<p>Generally we must check three conditions on the data before performing ANOVA:</p>


<ul>
  <li><p>the observations are independent within and between groups,</p></li>
  <li><p>the responses within each group are nearly normal, and</p></li>
  <li><p>the variability across the groups is about equal.</p></li>
</ul>


<p>When the three technical conditions are met, we may perform an ANOVA to determine whether the data provide convincing evidence against the null hypothesis that all the <m>\mu_j</m> are equal.</p>


<example>
  <statement>
    <p>College departments commonly run multiple sections of the same introductory course each semester because of high demand.</p>
    <p>Consider a statistics department that runs three sections of an introductory statistics course.</p>
    <p>We might like to determine whether there are substantial differences in first exam scores in these three classes (Section A, Section B, and Section C).</p>
    <p>Describe appropriate hypotheses to determine whether there are any differences between the three classes.</p>
  </statement>
  <solution>
    <p>The hypotheses may be written in the following form:</p>
    <ul>
      <li><p><m>H_0:</m> The average score is identical in all sections, <m>\mu_A = \mu_B = \mu_C</m>. Assuming each class is equally difficult, the observed difference in the exam scores is due to chance.</p></li>
      <li><p><m>H_A:</m> The average score varies by class. We would reject the null hypothesis in favor of the alternative hypothesis if there were larger differences among the class averages than what we might expect from chance alone.</p></li>
    </ul>
  </solution>
</example>


<p>Strong evidence favoring the alternative hypothesis in ANOVA is described by unusually large differences among the group means. We will soon learn that assessing the variability of the group means relative to the variability among individual observations within each group is key to ANOVA's success.</p>


<example>
  <statement>
    <p>Examine <xref ref="fig-toyANOVA" />.</p>
    <p>Compare groups I, II, and III.</p>
    <p>Can you visually determine if the differences in the group centers is unlikely to have occurred if there were no differences in the groups?</p>
    <p>Now compare groups IV, V, and VI.</p>
    <p>Do these differences appear to be unlikely to have occurred if there were no differences in the groups?</p>
  </statement>
  <solution>
    <p>Any real difference in the means of groups I, II, and III is difficult to discern, because the data within each group are very volatile relative to any differences in the average outcome.</p>
    <p>On the other hand, it appears there are differences in the centers of groups IV, V, and VI.</p>
    <p>For instance, group V appears to have a higher mean than that of the other two groups.</p>
    <p>Investigating groups IV, V, and VI, we see the differences in the groups' centers are noticeable because those differences are large <em>relative to the variability in the individual observations within each group</em>.</p>
  </solution>
</example>


<figure xml:id="fig-toyANOVA">
  <caption>Side-by-side dot plot for the outcomes for six groups. Two sets of groups; first set is comprised of Groups I, II, and III, the second set is comprised of Groups IV, V, and VI.</caption>
  <image source="images/fig-toyANOVA-1.png" width="70%" />
</figure>

<listing xml:id="fig-toyANOVA-code">
  <caption>R code for fig-toyANOVA</caption>
  <program language="r">
    <input>
toy_anova |&gt;
  mutate(group2 = if_else(group %in% c("I", "II", "III"), "A", "B")) |&gt;
  ggplot(aes(x = group, y = outcome, color = group2, shape = group2)) +
  geom_point(alpha = 0.7, size = 2, show.legend = FALSE) +
  scale_color_openintro() +
  facet_wrap(~group2, nrow = 1, scales = "free_x") +
  labs(x = "Group", y = "Outcome") +
  theme(strip.text = element_blank())
    </input>
  </program>
</listing>


<section>
  <title>Case study: Batting</title>


<p>We would like to discern whether there are real differences between the batting performance of baseball players according to their position: outfielder (OF), infielder (IF), and catcher (C). We will use a dataset called <c>mlb_players_18</c>, which includes batting records of 429 Major League Baseball (MLB) players from the 2018 season who had at least 100 at bats. Six of the 429 cases represented in <c>mlb_players_18</c> are shown in <xref ref="tbl-mlbBat18DataFrame" />, and descriptions for each variable are provided in <xref ref="tbl-mlbBat18Variables" />. The measure we will use for the player batting performance (the outcome variable) is on-base percentage (<c>OBP</c>). The on-base percentage roughly represents the fraction of the time a player successfully gets on base or hits a home run.</p>




<table xml:id="tbl-mlbBat18DataFrame">
  <title>Six cases and some of the variables from the <c>mlb_players_18</c> data frame.</title>
  <image source="images/tbl-mlbBat18DataFrame-1.png" width="70%" />
</table>

<listing xml:id="tbl-mlbBat18DataFrame-code">
  <caption>R code for tbl-mlbBat18DataFrame</caption>
  <program language="r">
    <input>
mlb_players_18 |&gt;
  arrange(name) |&gt;
  select(name, team, position, AB, H, HR, RBI, AVG, OBP) |&gt;
  slice_head(n = 6) |&gt;
  kbl(linesep = "", booktabs = TRUE, align = "lllrrrrrr") |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped"), full_width = TRUE
  ) |&gt;
  column_spec(1, width = "7em")
    </input>
  </program>
</listing>



<table xml:id="tbl-mlbBat18Variables">
  <title>Variables and their descriptions for the <c>mlb_players_18</c> dataset.</title>
  <image source="images/tbl-mlbBat18Variables-1.png" width="70%" />
</table>

<listing xml:id="tbl-mlbBat18Variables-code">
  <caption>R code for tbl-mlbBat18Variables</caption>
  <program language="r">
    <input>
mlb_players_18_vars &lt;- tribble(
  ~variable, ~col1,
  "name", "Player name",
  "team", "The abbreviated name of the player's team",
  "position", "The player's primary field position (OF, IF, C)",
  "AB", "Number of opportunities at bat",
  "H", "Number of hits",
  "HR", "Number of home runs",
  "RBI", "Number of runs batted in",
  "AVG", "Batting average, which is equal to H/AB",
  "OBP", "On-base percentage, which is roughly equal to the fraction of times a player gets on base or hits a home run"
)

mlb_players_18_vars |&gt;
  kbl(
    linesep = "", booktabs = TRUE,
    col.names = c("Variable", "Description")
  ) |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped"), full_width = TRUE
  ) |&gt;
  column_spec(1, monospace = TRUE) |&gt;
  column_spec(2, width = "30em")
    </input>
  </program>
</listing>


<exercise>
  <title>The null hypothesis under consideration is the following: <m>\mu_{OF} = \mu_{IF} = \mu_{C} % = \mu_{DH}.</m> Write the null and corresponding alternative hypotheses in plain language.</title>
  <statement>
  </statement>
  <solution>
    <p><m>H_0:</m> The average on-base percentage is equal across the four positions.</p>
    <p><m>H_A:</m> The average on-base percentage varies across some (or all) groups.</p>
  </solution>
</exercise>



<example>
  <statement>
    <p>The player positions have been divided into three groups: outfield (OF), infield (IF), and catcher (C).</p>
    <p>What would be an appropriate point estimate of the on-base percentage by outfielders, <m>\mu_{OF}</m>?</p>
  </statement>
  <solution>
    <p>A good estimate of the on-base percentage by outfielders would be the sample average of <c>OBP</c> for just those players whose position is outfield: <m>\bar{x}_{OF} = 0.320.</m></p>
  </solution>
</example>



</section>

<section xml:id="sec-randANOVA">
  <title>Randomization test for comparing many means</title>


<p><xref ref="tbl-mlb" />HRPerABSummaryTable provides summary statistics for each group. A side-by-side box plots for the on-base percentage is shown in <xref ref="fig-mlb" />ANOVABoxPlot. Notice that the variability appears to be approximately constant across groups; nearly constant variance across groups is an important assumption that must be satisfied before we consider the ANOVA approach.</p>


<table xml:id="tbl-mlbHRPerABSummaryTable">
  <title>Summary statistics of on-base percentage, split by player position.</title>
  <image source="images/tbl-mlbHRPerABSummaryTable-1.png" width="70%" />
</table>

<listing xml:id="tbl-mlbHRPerABSummaryTable-code">
  <caption>R code for tbl-mlbHRPerABSummaryTable</caption>
  <program language="r">
    <input>
mlb_players_18 |&gt;
  group_by(position) |&gt;
  summarise(
    n    = n(),
    mean = round(mean(OBP), 3),
    sd   = round(sd(OBP), 3)
  ) |&gt;
  kbl(
    linesep = "", booktabs = TRUE,
    col.names = c("Position", "n", "Mean", "SD"),
    align = "lccc"
  ) |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped"), full_width = FALSE
  ) |&gt;
  column_spec(1:4, width = "6em")
    </input>
  </program>
</listing>


<figure xml:id="fig-mlbANOVABoxPlot">
  <caption>Side-by-side box plots of the on-base percentage for 429 players across three groups. There are a few potential outliers, but with large numbers of observations in each group, the outliers are not extreme enough to have an impact on the calculations, so it is not a concern for moving forward with the analysis.</caption>
  <image source="images/fig-mlbANOVABoxPlot-1.png" width="70%" />
</figure>

<listing xml:id="fig-mlbANOVABoxPlot-code">
  <caption>R code for fig-mlbANOVABoxPlot</caption>
  <program language="r">
    <input>
ggplot(mlb_players_18, aes(x = position, y = OBP)) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(0.15, 0.45, 0.05)) +
  labs(
    x = "Position",
    y = "On-base percentage"
  )
    </input>
  </program>
</listing>


<example>
  <statement>
    <p>The largest difference between the sample means is between the catcher and the outfielder positions.</p>
    <p>Consider again the original hypotheses:</p>
    <ul>
      <li><p><m>H_0:</m> <m>\mu_{OF} = \mu_{IF} = \mu_{C}</m></p></li>
      <li><p><m>H_A:</m> The average on-base percentage <m>(\mu_j)</m> varies across some (or all) groups.</p></li>
    </ul>
    <p>Why might it be inappropriate to run the test by simply estimating whether the difference of <m>\mu_{C}</m> and <m>\mu_{OF}</m> is "statistically discernible" at a 0.05 discernibility level?</p>
  </statement>
  <solution>
    <p>The primary issue here is that we are inspecting the data before picking the groups that will be compared.</p>
    <p>It is inappropriate to examine all data by eye (informal testing) and only afterwards decide which parts to formally test.</p>
    <p>This is called <term>data snooping</term> or <term>data fishing</term>.</p>
    <p>Naturally, we would pick the groups with the large differences for the formal test, and this would lead to an inflation in the Type I error rate.</p>
    <p>To understand inflated Type I error rates better, let's consider a slightly different problem.</p>
    <p>Suppose we are to measure the aptitude for students in 20 classes in a large elementary school at the beginning of the year.</p>
    <p>In this school, all students are randomly assigned to classrooms, so any differences we observe between the classes at the start of the year are completely due to chance.</p>
    <p>However, with so many groups, we will probably observe a few groups that look rather different from each other.</p>
    <p>If we select only the classes that look different and then perform a formal test, we will probably make the wrong conclusion that the assignment wasn't random.</p>
    <p>While we might only formally test differences for a few pairs of classes, we informally evaluated the other classes by eye before choosing the most extreme cases for a comparison.</p>
  </solution>
</example>


<p><!-- n.b. I removed this bit because the data snooping example above isn't related to the prosecutor's fallacy at all.</p>


<p>For additional information on the ideas expressed above, we recommend reading about the <term>prosecutor's fallacy</term>.[^22-inference-many-means-2]</p>



<subsection>
  <title>Observed data</title>


<p>In the next section we will learn how to use the <m>F</m> statistic to test whether observed differences in sample means could have happened just by chance even if there was no difference in the respective population means.</p>


<p>The method of analysis of variance in this context focuses on answering one question: is the variability in the sample means so large that it seems unlikely to be from chance alone? This question is different from earlier testing procedures since we will <em>simultaneously</em> consider many groups, and evaluate whether their sample means differ more than we would expect from natural variation. We call this variability the <term>mean square between groups (MSG)</term> <m>(MSG)</m>, and it has an associated degrees of freedom, <m>df_{G} = k - 1</m> when there are <m>k</m> groups. The <m>MSG</m> can be thought of as a scaled variance formula for means. If the null hypothesis is true, any variation in the sample means is due to chance and shouldn't be too large. Details of <m>MSG</m> calculations are provided in the footnote.[^22-inference-many-means-3] However, we typically use software for these computations.</p>



<p>The mean square between the groups is, on its own, quite useless in a hypothesis test. We need a benchmark value for how much variability should be expected among the sample means if the null hypothesis is true. To this end, we compute a pooled variance estimate, often abbreviated as the <term>mean square error</term> <m>(MSE)</m>, which has an associated degrees of freedom value <m>df_E = n - k.</m> It is helpful to think of <m>MSE</m> as a measure of the variability within the groups. Details of the computations of the <m>MSE</m> and a link to an extra online section for ANOVA calculations are provided in the footnote.[^22-inference-many-means-4]</p>


<p>When the null hypothesis is true, any differences among the sample means are only due to chance, and the <m>MSG</m> and <m>MSE</m> should be about equal. As a test statistic for ANOVA, we examine the fraction of <m>MSG</m> and <m>MSE:</m></p>


<p>$<m>F = \frac{MSG}{MSE}</m>$</p>


<p>The <m>MSG</m> represents a measure of the between-group variability, and <m>MSE</m> measures the variability within each of the groups.</p>


<note>
  <title><term>The test statistic for three or more means is an F.</term></title>
  <p>The F statistic is a ratio of how the groups differ (MSG) as compared to how the observations within a group vary (MSE).</p>
  <p>$<m>F = \frac{MSG}{MSE}</m>$</p>
  <p>When the null hypothesis is true and the conditions are met, F has an F-distribution with <m>df_1 = k-1</m> and <m>df_2 = n-k.</m></p>
  <p>Conditions:</p>
  <p>-   independent observations, both within and across groups</p>
  <p>-   large samples and no extreme outliers</p>
</note>



</subsection>

<subsection>
  <title>Variability of the statistic</title>


<p>We recall the exams from <xref ref="sec-rand2mean" /> which demonstrated a two-sample randomization test for a comparison of means. Suppose now that the teacher had had such an extremely large class that three different exams were given: A, B, and C. <xref ref="tbl-summaryStatsForThreeVersionsOfExams" /> and <xref ref="fig-boxplotThreeVersionsOfExams" /> provide a summary of the data including exam C. Again, we would like to investigate whether the difficulty of the exams is the same across the three exams, so the test is</p>


<ul>
  <li><p><m>H_0: \mu_A = \mu_B = \mu_C.</m> The inherent average difficulty is the same across the three exams.</p></li>
  <li><p><m>H_A:</m> not <m>H_0.</m> At least one of the exams is inherently more (or less) difficult than the others.</p></li>
</ul>



<table xml:id="tbl-summaryStatsForThreeVersionsOfExams">
  <title>Summary statistics of scores for each exam version.</title>
  <image source="images/tbl-summaryStatsForThreeVersionsOfExams-1.png" width="70%" />
</table>

<listing xml:id="tbl-summaryStatsForThreeVersionsOfExams-code">
  <caption>R code for tbl-summaryStatsForThreeVersionsOfExams</caption>
  <program language="r">
    <input>
classdata &lt;- classdata |&gt;
  mutate(exam = str_to_upper(lecture))

classdata |&gt;
  group_by(exam) |&gt;
  summarise(
    n    = n(),
    mean = round(mean(m1), 1),
    sd   = round(sd(m1), 1),
    min  = min(m1),
    max  = max(m1)
  ) |&gt;
  kbl(
    linesep = "", booktabs = TRUE,
    col.names = c("Exam", "n", "Mean", "SD", "Min", "Max"),
    align = "lccccc"
  ) |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped"), full_width = FALSE
  ) |&gt;
  column_spec(1:6, width = "5em")
    </input>
  </program>
</listing>


<figure xml:id="fig-boxplotThreeVersionsOfExams">
  <caption>Exam scores for students given one of three different exams.</caption>
  <image source="images/fig-boxplotThreeVersionsOfExams-1.png" width="70%" />
</figure>

<listing xml:id="fig-boxplotThreeVersionsOfExams-code">
  <caption>R code for fig-boxplotThreeVersionsOfExams</caption>
  <program language="r">
    <input>
classdata |&gt;
  ggplot(aes(x = exam, y = m1, color = exam)) +
  geom_boxplot(show.legend = FALSE) +
  geom_point(show.legend = FALSE) +
  scale_color_manual(values = c(IMSCOL["red", "full"], IMSCOL["green", "full"], IMSCOL["blue", "full"])) +
  labs(
    x = "Exam",
    y = "Score",
    title = "Box plot of exam score broken down by version of exam."
  )
    </input>
  </program>
</listing>


<p><xref ref="fig-randANOVA" /> shows the process of randomizing the three different exams to the observed exam scores. If the null hypothesis is true, then the score on each exam should represent the true student ability on that material. It shouldn't matter whether they were given exam A or exam B or exam C. By reallocating which student got which exam, we are able to understand how the difference in average exam scores changes due only to natural variability. There is only one iteration of the randomization process in <xref ref="fig-randANOVA" />, leading to three different randomized sample means (computed assuming the null hypothesis is true).</p>


<figure xml:id="fig-randANOVA">
  <caption>The version of the test (A or B or C) is randomly allocated to the test scores, under the null assumption that the tests are equally difficult.</caption>
  <image source="images/fig-randANOVA-1.png" width="70%" />
</figure>

<listing xml:id="fig-randANOVA-code">
  <caption>R code for fig-randANOVA</caption>
  <program language="r">
    <input>
include_graphics("images/randANOVA.png")
    </input>
  </program>
</listing>


<p>In the two-sample case, the null hypothesis was investigated using the difference in the sample means. However, as noted above, with three groups (three different exams), the comparison of the three sample means gets slightly more complicated. We have already derived the F-statistic which is exactly the way to compare the averages across three or more groups! Recall, the F statistic is a ratio of how the groups differ (MSG) as compared to how the observations within a group vary (MSE).</p>


<p>Building on <xref ref="fig-randANOVA" />, <xref ref="fig-rand3exams" /> shows the values of the simulated <m>F</m> statistics over 1,000 random simulations. We see that, just by chance, the F statistic can be as large as 7.</p>


<figure xml:id="fig-rand3exams">
  <caption>Histogram of F statistics calculated from 1,000 different randomizations of the exam type.</caption>
  <image source="images/fig-rand3exams-1.png" width="70%" />
</figure>

<listing xml:id="fig-rand3exams-code">
  <caption>R code for fig-rand3exams</caption>
  <program language="r">
    <input>
set.seed(47)
classdata |&gt;
  specify(m1 ~ exam) |&gt;
  hypothesize(null = "independence") |&gt;
  generate(reps = 1000, type = "permute") |&gt;
  calculate(stat = "F") |&gt;
  visualize() +
  labs(
    y = "Count",
    title = "1,000 randomized F statistics",
    x = "F statistic for 1,000 randomizations of the exams."
  )
    </input>
  </program>
</listing>


</subsection>

<subsection>
  <title>Observed statistic vs. null statistics</title>


<figure xml:id="fig-rand3examspval">
  <caption>Histogram of F statistics calculated from 1000 different randomizations of the exam type. The observed F statistic is given as a red vertical line at 3.48. The area to the right is more extreme than the observed value and represents the p-value.</caption>
  <image source="images/fig-rand3examspval-1.png" width="70%" />
</figure>

<listing xml:id="fig-rand3examspval-code">
  <caption>R code for fig-rand3examspval</caption>
  <program language="r">
    <input>
class_Fstat &lt;- classdata |&gt;
  specify(m1 ~ exam) |&gt;
  calculate(stat = "F") |&gt;
  pull()

set.seed(47)
classdata |&gt;
  specify(m1 ~ exam) |&gt;
  hypothesize(null = "independence") |&gt;
  generate(reps = 1000, type = "permute") |&gt;
  calculate(stat = "F") |&gt; # get_p_value(obs_stat = class_Fstat, direction = "greater")
  visualize() +
  shade_p_value(
    obs_stat = class_Fstat, direction = "greater",
    fill = IMSCOL["red", "f3"], color = IMSCOL["red", "full"]
  ) +
  labs(
    y = "Count",
    title = "1,000 randomized F statistics",
    x = "F statistic for 1,000 randomizations of the exams."
  )
    </input>
  </program>
</listing>


<p>Using statistical software, we can calculate that 3.6% of the randomized F test statistics were at or above the observed test statistic of <m>F= 3.48.</m> That is, the p-value of the test is 0.036. Assuming that we had set the level of discernibility to be <m>\alpha = 0.05,</m> the p-value is smaller than the level of discernibility which would lead us to reject the null hypothesis. We claim that the difficulty level (i.e., the true average score, <m>\mu)</m> is different for at least one of the exams.</p>


<p>While it is temping to say that exam C is harder than the other two (given the inability to differentiate between exam A and exam B in <xref ref="sec-rand2mean" />), we must be very careful about conclusions made using different techniques on the same data.</p>


<p>When the null hypothesis is true, random variability that exists in nature sometimes produces data with p-values less than 0.05. How often does that happen? 5% of the time. That is to say, if you use 20 different models applied to the same data where there is no signal (i.e., the null hypothesis is true), you are reasonably likely to get a p-value less than 0.05 in one of the tests you run. The details surrounding the ideas of this problem, called a <term>multiple comparisons test</term> or <term>multiple comparisons problem</term>, are outside the scope of this textbook, but should be something that you keep in the back of your head. To best mitigate any extra Type I errors, we suggest that you set up your hypotheses and testing protocol before running any analyses. Once the conclusions have been reached, you should report your findings instead of running a different type of test on the same data.</p>


</subsection>

</section>

<section xml:id="sec-mathANOVA">
  <title>Mathematical model for test for comparing many means</title>


<p>As seen with many of the tests and statistics from previous sections, the randomization test on the F statistic has corresponding mathematical theory to describe the distribution that can be used without using a computational approach.</p>


<p>We return to the baseball example from <xref ref="tbl-mlb" />HRPerABSummaryTable to demonstrate the mathematical model applied to the ANOVA setting.</p>



<subsection>
  <title>Variability of the statistic</title>


<p>The larger the observed variability in the sample means <m>(MSG)</m> relative to the within-group observations <m>(MSE)</m>, the larger <m>F</m>-statistic will be and the stronger the evidence against the null hypothesis. Because larger <m>F</m>-statistics represent stronger evidence against the null hypothesis, we use the upper tail of the distribution to compute a p-value.</p>


<note>
  <title><term>The F statistic and the F-test.</term></title>
  <p>Analysis of variance (ANOVA) is used to test whether the mean outcome differs across two or more groups.</p>
  <p>ANOVA uses a test statistic, the <m>F</m>-statistic, which represents a standardized ratio of variability in the sample means relative to the variability within the groups.</p>
  <p>If <m>H_0</m> is true and the model conditions are satisfied, an <m>F</m>-statistic follows an <m>F</m> distribution with parameters <m>df_{1} = k - 1</m> and <m>df_{2} = n - k.</m> The upper tail of the <m>F</m> distribution is used to represent the p-value.</p>
</note>


<exercise>
  <title>For the baseball data, <m>MSG = 0.00803</m> and <m>MSE=0.00158</m>. Identify the degrees of freedom associated with MSG and MSE and verify the <m>F</m>-statistic is approximately 5.077.</title>
  <statement>
  </statement>
  <solution>
    <p>There are <m>k = 3</m> groups, so <m>df_{G} = k - 1 = 2.</m> There are <m>n = n_1 + n_2 + n_3 = 429</m> total observations, so <m>df_{E} = n - k = 426.</m> Then the <m>F</m>-statistic is computed as the ratio of <m>MSG</m> and <m>MSE:</m> <m>F = \frac{MSG}{MSE} = \frac{0.00803}{0.00158} = 5.082 \approx 5.077.</m> <m>(F = 5.077</m> was computed by using values for <m>MSG</m> and <m>MSE</m> that were not rounded.)</p>
  </solution>
</exercise>


</subsection>

<subsection>
  <title>Observed statistic vs. null statistics</title>


<p>We can use the <m>F</m>-statistic to evaluate the hypotheses in what is called an F-test. A p-value can be computed from the <m>F</m> statistic using an <m>F</m> distribution, which has two associated parameters: <m>df_{1}</m> and <m>df_{2}.</m> For the <m>F</m>-statistic in ANOVA, <m>df_{1} = df_{G}</m> and <m>df_{2} = df_{E}.</m> An <m>F</m> distribution with 2 and 426 degrees of freedom, corresponding to the <m>F</m> statistic for the baseball hypothesis test, is shown in <xref ref="fig-fDist2And423Shaded" />.</p>



<figure xml:id="fig-fDist2And423Shaded">
  <caption>An <m>F</m> distribution with <m>df_1=2</m> and <m>df_2=426.</m></caption>
  <image source="images/fig-fDist2And423Shaded-1.png" width="70%" />
</figure>

<listing xml:id="fig-fDist2And423Shaded-code">
  <caption>R code for fig-fDist2And423Shaded</caption>
  <program language="r">
    <input>
X &lt;- seq(0, 8, len = 300)
Y &lt;- df(X, 2.00001, 426)
par(mar = c(2, 0, 0, 0))
plot(X, Y,
  type = "l",
  xlab = "F",
  ylab = "",
  axes = FALSE
)
lines(c(0, 8), rep(0, 2))
axis(1)
temp &lt;- which(X &gt; 5.077)
x &lt;- X[c(temp, rev(temp), temp[1])]
y &lt;- c(Y[temp], rep(0, length(temp)), Y[temp[1]])
polygon(x, y, col = IMSCOL["red", "full"], border = IMSCOL["red", "full"], lwd = 2)
arrows(6.3, 0.3, 6.5, 0.05, length = 0.05)
text(6.3, 0.3, "Small tail area", pos = 3)
    </input>
  </program>
</listing>


<example>
  <statement>
    <p>The p-value corresponding to the shaded area in <xref ref="fig-fDist2And423Shaded" /> is equal to about 0.0066.</p>
    <p>Does this provide strong evidence against the null hypothesis?</p>
  </statement>
  <solution>
    <p>The p-value is smaller than 0.05, indicating the evidence is strong enough to reject the null hypothesis at a discernibility level of 0.05.</p>
    <p>That is, the data provide strong evidence that the average on-base percentage varies by player's primary field position.</p>
  </solution>
</example>


<p>Note that the small p-value indicates that there is a notable difference between the mean batting averages of the different positions. However, the ANOVA test does not provide a mechanism for knowing <em>which</em> group is driving the differences. If we move forward with all possible two mean comparisons, we run the risk of a high Type I error rate. As we saw at the end of <xref ref="sec-randANOVA" />, the follow-up questions surrounding individual group comparisons is called a problem of <term>multiple comparisons</term> and is outside the scope of this text. We encourage you to learn more about multiple comparisons, however, so that additional comparisons, after you have rejected the null hypothesis in an ANOVA test, do not lead to undue false positive conclusions.</p>



</subsection>

<subsection>
  <title>Reading an ANOVA table from software</title>


<p>The calculations required to perform an ANOVA by hand are tedious and prone to human error. For these reasons, it is common to use statistical software to calculate the <m>F</m>-statistic and p-value.</p>


<p>An ANOVA analysis can be summarized in a table very similar to that of a regression summary, which we saw in <xref ref="sec-model-slr" /> and <xref ref="sec-model-mlr" />. <xref ref="tbl-anovaSummaryTableForOBPAgainstPosition" /> shows an ANOVA summary to test whether the mean of on-base percentage varies by player positions in the MLB. Many of these values should look familiar; in particular, the <m>F</m>-statistic and p-value can be retrieved from the last two columns.</p>


<table xml:id="tbl-anovaSummaryTableForOBPAgainstPosition">
  <title>ANOVA summary for testing whether the average on-base percentage differs across player positions.</title>
  <image source="images/tbl-anovaSummaryTableForOBPAgainstPosition-1.png" width="70%" />
</table>

<listing xml:id="tbl-anovaSummaryTableForOBPAgainstPosition-code">
  <caption>R code for tbl-anovaSummaryTableForOBPAgainstPosition</caption>
  <program language="r">
    <input>
mod &lt;- lm(OBP ~ position, data = mlb_players_18)

anova(mod) |&gt;
  tidy() |&gt;
  mutate(p.value = ifelse(p.value &lt; 0.0001, "&lt;0.0001", round(p.value, 4))) |&gt;
  kbl(
    linesep = "", booktabs = TRUE,
    digits = 4, align = "lrrrrr"
  ) |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped")
  ) |&gt;
  column_spec(1, width = "10em", monospace = TRUE) |&gt;
  column_spec(2:6, width = "5em")
    </input>
  </program>
</listing>


</subsection>

<subsection>
  <title>Conditions for an ANOVA analysis</title>


<p>There are three conditions we must check for an ANOVA analysis: all observations must be independent, the data in each group must be nearly normal (or each group must have reasonably large sample sizes), and the variance within each group must be approximately equal.</p>


<ul>
  <li><p><term>Independence.</term> If the data are a simple random sample, this condition can be assumed to be satisfied.</p></li>
</ul>

<p>For processes and experiments, carefully consider whether the data may be independent (e.g., no pairing). For example, in the MLB data, the data were not sampled. However, there are not obvious reasons why independence would not hold for most or all observations.</p>


<ul>
  <li><p><term>Approximately normal.</term> As with one- and two-sample testing for means, the normality assumption is especially important when the sample size is quite small when it is ironically difficult to check for non-normality.</p></li>
</ul>

<p>A histogram of the observations from each group is shown in <xref ref="fig-mlb" />ANOVADiagNormalityGroups. Since each of the groups we are considering have relatively large sample sizes, what we are looking for are major outliers. None are apparent, so this conditions is reasonably met.</p>


<ul>
  <li><p><term>Constant variance.</term> The last assumption is that the variance in the groups is about equal from one group to the next. This assumption can be checked by examining side-by-side box plots of the outcomes across the groups, as in <xref ref="fig-mlb" />ANOVABoxPlot. In this case, the variability is similar in the four groups but not identical. We see in <xref ref="tbl-mlb" />HRPerABSummaryTable that the standard deviation does not vary much from one group to the next.</p></li>
</ul>


<note>
  <title><term>Diagnostics for an ANOVA analysis.</term></title>
  <p>Independence is always important to an ANOVA analysis.</p>
  <p>The normality condition is important when the sample sizes for each group are relatively small (if the group sizes are large, the observations do not need to be normal but should also not contain any large outliers).</p>
  <p>The constant variance condition is especially important when the sample sizes differ between groups.</p>
</note>


<figure xml:id="fig-mlbANOVADiagNormalityGroups">
  <caption>Histograms of OBP for each field position.</caption>
  <image source="images/fig-mlbANOVADiagNormalityGroups-1.png" width="70%" />
</figure>

<listing xml:id="fig-mlbANOVADiagNormalityGroups-code">
  <caption>R code for fig-mlbANOVADiagNormalityGroups</caption>
  <program language="r">
    <input>
mlb_players_18 |&gt;
  mutate(
    position = case_when(
      position == "OF" ~ "Outfielders",
      position == "IF" ~ "Infielders",
      position == "C" ~ "Catchers"
    ),
    position = fct_relevel(position, "Outfielders", "Infielders", "Catchers")
  ) |&gt;
  ggplot(aes(x = OBP)) +
  geom_histogram() +
  facet_wrap(~position, ncol = 1, scales = "free_y") +
  labs(
    x = "On-base percentage",
    y = "Count"
  )
    </input>
  </program>
</listing>



</subsection>

</section>

<section xml:id="sec-chp22-review">
  <title>Chapter review</title>


<subsection>
  <title>Summary</title>


<p>In this chapter we have provided both the randomization test and the mathematical model appropriate for addressing questions of equality of means across two or more groups. Note that there were important technical conditions required for confirming that the F distribution appropriately modeled the ANOVA test statistic. Also, you may have noticed that there was no discussion of creating confidence intervals. That is because the ANOVA statistic does not have a direct analogue parameter to estimate. If there is interest in comparisons of mean differences (across each set of two groups), then the methods from <xref ref="sec-inference-two-means" /> comparing two independent means should be applied.</p>


</subsection>

<subsection>
  <title>Terms</title>


<p>The terms introduced in this chapter are presented in <xref ref="tbl-terms-chp-22" />. If you're not sure what some of these terms mean, we recommend you go back in the text and review their definitions. You should be able to easily spot them as <term>bolded text</term>.</p>


<table xml:id="tbl-terms-chp-22">
  <title>Terms introduced in this chapter.</title>
  <image source="images/tbl-terms-chp-22-1.png" width="70%" />
</table>

<listing xml:id="tbl-terms-chp-22-code">
  <caption>R code for tbl-terms-chp-22</caption>
  <program language="r">
    <input>
make_terms_table(terms_chp_22)
    </input>
  </program>
</listing>



</subsection>

</section>

<section xml:id="sec-chp22-exercises">
  <title>Exercises</title>


<p>Answers to odd-numbered exercises can be found in <xref ref="sec-exercise-solutions-22" />.</p>


<!-- <xi:include href="../exercises/_22-ex-inference-many-means.ptx"/> -->

</section>

</chapter>