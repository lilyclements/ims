<?xml version="1.0" encoding="UTF-8"?>

<chapter xml:id="ch25-inference-linear-regression-multiple" xmlns:xi="http://www.w3.org/2001/XInclude">

<title>Inference for linear regression with multiple predictors</title>

<introduction>
  <p>In <xref ref="sec-model-mlr" />, the least squares regression method was used to estimate linear models which predicted a particular response variable given more than one explanatory variable.</p>
  <p>Here, we discuss whether each of the variables individually is a statistically discernible predictor of the outcome or whether the model might be just as strong without that variable.</p>
  <p>That is, as before, we apply inferential methods to ask whether a variable could have come from a population where the particular coefficient at hand was zero.</p>
  <p>If one of the linear model coefficients is truly zero (in the population), then the estimate of the coefficient (using least squares) will vary around zero.</p>
  <p>The inference task at hand is to decide whether the coefficient's difference from zero is large enough to decide that the data cannot possibly have come from a model where the true population coefficient is zero.</p>
  <p>Both the derivations from the mathematical model and the randomization model are beyond the scope of this book, but we are able to calculate p-values using statistical software.</p>
  <p>We will discuss interpreting p-values in the multiple regression setting and note some scenarios where careful understanding of the context and the relationship between variables is important.</p>
  <p>We use cross-validation as a method for independent assessment of the multiple linear regression model.</p>
</introduction>

<section xml:id="sec-inf-mult-reg-soft">
  <title>Multiple regression output from software</title>

<p>Recall the <c>loans</c> data from <xref ref="sec-model-mlr" />.</p>

<note>
  <title>Data</title>
  <p>The <url href="http://openintrostat.github.io/openintro/reference/loans_full_schema.html"><c>loans_full_schema</c></url> data can be found in the <url href="http://openintrostat.github.io/openintro"><alert>openintro</alert></url> R package.</p>
  <p>Based on the data in this dataset we have created two new variables: <c>credit_util</c> which is calculated as the total credit utilized divided by the total credit limit and <c>bankruptcy</c> which turns the number of bankruptcies to an indicator variable (0 for no bankruptcies and 1 for at least 1 bankruptcy).</p>
  <p>We will refer to this modified dataset as <c>loans</c>.</p>
</note>

<p>Now, our goal is to create a model where <c>interest_rate</c> can be predicted using the variables <c>debt_to_income</c>, <c>term</c>, and <c>credit_checks</c>.</p>
<p>As you learned in <xref ref="sec-model-mlr" />, least squares can be used to find the coefficient estimates for the linear model.</p>
<p>The unknown population model can be written as:</p>

<md>
  <mrow>E[\texttt{interest\_rate}] = \beta_0 \amp+ \beta_1\times \texttt{debt\_to\_income}</mrow>
  <mrow>\amp+ \beta_2 \times \texttt{term}</mrow>
  <mrow>\amp+ \beta_3 \times \texttt{credit\_checks}</mrow>
</md>

<listing xml:id="listing-loansmodel-code">
  <caption>R code for fitting the loans multiple regression model</caption>
  <program language="r">
    <input>
loans &lt;- loans_full_schema |&gt;
  mutate(
    credit_util = total_credit_utilized / total_credit_limit,
    bankruptcy = as.factor(if_else(public_record_bankrupt == 0, 0, 1)),
    verified_income = droplevels(verified_income)
  ) |&gt;
  rename(credit_checks = inquiries_last_12m) |&gt;
  select(interest_rate, verified_income, debt_to_income, credit_util, 
         bankruptcy, term, credit_checks, issue_month)

lm(interest_rate ~ debt_to_income + term + credit_checks, data = loans) |&gt;
  tidy() |&gt;
  mutate(p.value = ifelse(p.value &lt; 0.0001, "&lt;0.0001", round(p.value, 4))) |&gt;
  kbl(
    linesep = "", booktabs = TRUE,
    digits = 2, align = "lrrrr"
  ) |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped")
  ) |&gt;
  column_spec(1, width = "10em", monospace = TRUE) |&gt;
  column_spec(2:5, width = "5em")
    </input>
  </program>
</listing>

<table xml:id="tbl-loansmodel">
  <title>Summary of a linear model for predicting interest rate based on <c>debt_to_income</c>, <c>term</c>, and <c>credit_checks</c>. Each of the variables has its own coefficient estimate as well as a p-value.</title>
  <tabular>
    <row header="yes">
      <cell>term</cell>
      <cell>estimate</cell>
      <cell>std.error</cell>
      <cell>statistic</cell>
      <cell>p.value</cell>
    </row>
    <row>
      <cell>(Intercept)</cell>
      <cell>4.31</cell>
      <cell>0.13</cell>
      <cell>33.53</cell>
      <cell>&lt;0.0001</cell>
    </row>
    <row>
      <cell>debt_to_income</cell>
      <cell>0.04</cell>
      <cell>0.00</cell>
      <cell>23.79</cell>
      <cell>&lt;0.0001</cell>
    </row>
    <row>
      <cell>term</cell>
      <cell>0.16</cell>
      <cell>0.00</cell>
      <cell>81.14</cell>
      <cell>&lt;0.0001</cell>
    </row>
    <row>
      <cell>credit_checks</cell>
      <cell>0.25</cell>
      <cell>0.02</cell>
      <cell>12.52</cell>
      <cell>&lt;0.0001</cell>
    </row>
  </tabular>
</table>

<p>The estimated equation for the regression model may be written as a model with three predictor variables:</p>

<me>\widehat{\texttt{interest\_rate}} = 4.31 + 0.041 \times \texttt{debt\_to\_income} + 0.16 \times \texttt{term} + 0.25 \times \texttt{credit\_checks}</me>

<p>Not only does <xref ref="tbl-loansmodel" /> provide the estimates for the coefficients, it also provides information on the inference analysis (i.e., hypothesis testing) which is the focus of this chapter.</p>

<p>In <xref ref="ch24-inference-linear-regression-single" />, you learned that the hypothesis test for a linear model with <alert>one predictor</alert><idx><h>variable</h><h>predictor</h></idx><idx>predictor variable</idx><fn>In previous sections, the term <alert>explanatory variable</alert><idx><h>variable</h><h>explanatory</h></idx><idx>explanatory variable</idx> was used instead of <alert>predictor</alert>. The words are synonymous and are used separately in the different sections to be consistent with how most analysts use them: explanatory variable for testing, predictor for modeling.</fn> can be written as:</p>

<p>if only one predictor, <m>H_0: \beta_1 = 0.</m></p>

<p>That is, if the true population slope is zero, the p-value measures how likely it would be to select data which produced the observed slope <m>(b_1)</m> value.</p>

<p>With <alert>multiple predictors</alert><idx><h>variable</h><h>multiple predictors</h></idx><idx>multiple predictors</idx>, the hypothesis is similar, however, it is now conditioned on each of the other variables remaining in the model.</p>

<p>if multiple predictors, <m>H_0: \beta_i = 0</m> given other variables in the model</p>

<p>Using the example above and focusing on each of the variable p-values (here we won't discuss the p-value associated with the intercept), we can write out the three different hypotheses:</p>

<p><ul>
  <li><m>H_0: \beta_1 = 0</m>, given <c>term</c> and <c>credit_checks</c> are included in the model</li>
  <li><m>H_0: \beta_2 = 0</m>, given <c>debt_to_income</c> and <c>credit_checks</c> are included in the model</li>
  <li><m>H_0: \beta_3 = 0</m>, given <c>debt_to_income</c> and <c>term</c> are included in the model</li>
</ul></p>

<p>The very low p-values from the software output tell us that each of the variables acts as an important predictor in the model, despite the inclusion of the other two.</p>
<p>Consider the p-value on <m>H_0: \beta_1 = 0</m>.</p>
<p>The low p-value says that it would be extremely unlikely to see data that produce a coefficient on <c>debt_to_income</c> as large as 0.041 if the true relationship between <c>debt_to_income</c> and <c>interest_rate</c> was non-existent (i.e., if <m>\beta_1 = 0</m>) and the model also included <c>term</c> and <c>credit_checks</c>.</p>
<p>You might have thought that the value 0.041 is a small number (i.e., close to zero), but in the units of the problem, 0.041 turns out to be far away from zero, it's all about context!</p>
<p>The p-values on <c>term</c> and on <c>credit_checks</c> are interpreted similarly.</p>

<p>Sometimes a set of predictor variables can impact the model in unusual ways, often due to the predictor variables themselves being correlated.</p>

</section>

<section xml:id="sec-inf-mult-reg-collin">
  <title>Multicollinearity</title>

<p>In practice, there will almost always be some degree of correlation between the explanatory variables in a multiple regression model.</p>
<p>For regression models, it is important to understand the entire context of the model, particularly for correlated variables.</p>
<p>Our discussion will focus on interpreting coefficients (and their signs) in relationship to other variables as well as the discernibility (i.e., the p-value) of each coefficient.</p>

<p>Consider an example where we would like to predict how much money is in a coin dish based only on the number of coins in the dish.</p>
<p>We ask 26 students to tell us about their individual coin dishes, collecting data on the total dollar amount, the total number of coins, and the total number of low coins.<fn>In all honesty, this particular dataset is fabricated, and the original idea for the problem comes from Jeff Witmer at Oberlin College.</fn></p>
<p>The number of low coins is the number of coins minus the number of quarters (a quarter is the largest commonly used US coin, at US$0.25).</p>
<p><xref ref="fig-money" /> illustrates a sample of U.S. coins, their total worth (<c>total_amount</c>), the total <c>number_of_coins</c>, and the <c>number_of_low_coins</c>.</p>

<figure xml:id="fig-money">
  <caption>A sample of coins with 16 total coins, 10 low coins, and a net worth of $1.90.</caption>
  <image source="images/money.png" width="65%" />
</figure>

<p>The collected data is given in <xref ref="fig-coinfig" /> and shows that the <c>total_amount</c> of money is more highly correlated with the total <c>number_of_coins</c> than it is with the <c>number_of_low_coins</c>.</p>
<p>We also note that the total <c>number_of_coins</c> and the <c>number_of_low_coins</c> are positively correlated.</p>

<figure xml:id="fig-coinfig">
  <caption>Two plots describing the total amount of money (USD) as a function of the total number of coins or low coins. As you might expect, the total amount of money is more highly positively correlated with the total number of coins than with the number of low coins.</caption>
  <sidebyside widths="45% 45%">
    <figure xml:id="fig-coinfig-1">
      <caption>Total number of coins on the x-axis.</caption>
      <image source="images/fig-coinfig-1.png" />
    </figure>
    <figure xml:id="fig-coinfig-2">
      <caption>Number of low coins on the x-axis.</caption>
      <image source="images/fig-coinfig-2.png" />
    </figure>
  </sidebyside>
</figure>

<listing xml:id="listing-coinfig-code">
  <caption>R code for creating coin amount plots</caption>
  <program language="r">
    <input>
# Data are simulated
money &lt;- tibble(
  number_of_coins = c(9, 10, 3, 5, 10, 37, 28, 9, 11, 4, 6, 17, 15, 7, 9, 1, 5, 9, 36, 30, 47, 13, 5, 7, 18, 16),
  number_of_low_coins = c(4, 8, 0, 4, 9, 34, 9, 3, 2, 2, 5, 12, 11, 4, 8, 0, 4, 9, 34, 9, 3, 2, 2, 5, 12, 11),
  total_amount = c(1.37, 1.01, 1.5, 0.56, 0.61, 3.06, 5.42, 1.75, 5.4, 0.56, 0.34, 2.33, 3.34, 1.3, 1.2, 1.7, 0.86, 0.61, 2.96, 5.52, 8.95, 5.2, 1.56, 0.74, 1.83, 3.74)
)

ggplot(money, aes(y = total_amount, x = number_of_coins)) +
  geom_point() +
  labs(x = "Number of coins", y = "Total amount (USD)")

ggplot(money, aes(y = total_amount, x = number_of_low_coins)) +
  geom_point() +
  labs(x = "Number of low coins", y = "Total amount (USD)")
    </input>
  </program>
</listing>

<p>Using the total <c>number_of_coins</c> as the predictor variable, <xref ref="tbl-coinhigh" /> provides the least squares estimate of the coefficient is 0.13.</p>
<p>For every additional coin in the dish, we would predict that the student had US$0.13 more.</p>
<p>The <m>b_1 = 0.13</m> coefficient has a small p-value associated with it, suggesting we would not have seen data like this if <c>number_of_coins</c> and <c>total_amount</c> of money were not linearly related.</p>

<me>\widehat{\texttt{total\_amount}} = 0.55 + 0.13 \times \texttt{number\_of\_coins}</me>

<listing xml:id="listing-coinhigh-code">
  <caption>R code for linear model with total number of coins</caption>
  <program language="r">
    <input>
lm(total_amount ~ number_of_coins, data = money) |&gt;
  tidy() |&gt;
  mutate(p.value = ifelse(p.value &lt; .0001, "&lt;0.0001", round(p.value, 4))) |&gt;
  kbl(
    linesep = "", booktabs = TRUE,
    digits = 2
  ) |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped")
  ) |&gt;
  column_spec(1, width = "10em", monospace = TRUE) |&gt;
  column_spec(2:5, width = "5em")
    </input>
  </program>
</listing>

<table xml:id="tbl-coinhigh">
  <title>Linear model output predicting the total amount of money based on the total number of coins.</title>
  <tabular>
    <row header="yes">
      <cell>term</cell>
      <cell>estimate</cell>
      <cell>std.error</cell>
      <cell>statistic</cell>
      <cell>p.value</cell>
    </row>
    <row>
      <cell>(Intercept)</cell>
      <cell>0.55</cell>
      <cell>0.45</cell>
      <cell>1.22</cell>
      <cell>0.2357</cell>
    </row>
    <row>
      <cell>number_of_coins</cell>
      <cell>0.13</cell>
      <cell>0.02</cell>
      <cell>5.43</cell>
      <cell>&lt;0.0001</cell>
    </row>
  </tabular>
</table>

<p>Using <c>number_of_low_coins</c> as the predictor variable, <xref ref="tbl-coinlow" /> provides the least squares estimate of the coefficient is 0.02.</p>
<p>For every additional low coin in the dish, we would predict that the student had US$0.02 more.</p>
<p>The <m>b_1 = 0.02</m> coefficient has a large p-value associated with it, suggesting we could easily have seen data like ours even if the <c>number_of_low_coins</c> and <c>total_amount</c> of money are not at all linearly related.</p>

<me>\widehat{\texttt{total\_amount}} = 2.28 + 0.02 \times \texttt{number\_of\_low\_coins}</me>

<listing xml:id="listing-coinlow-code">
  <caption>R code for linear model with number of low coins</caption>
  <program language="r">
    <input>
lm(total_amount ~ number_of_low_coins, data = money) |&gt;
  tidy() |&gt;
  mutate(p.value = ifelse(p.value &lt; .0001, "&lt;0.0001", round(p.value, 4))) |&gt;
  kbl(
    linesep = "", booktabs = TRUE,
    digits = 2, align = "lrrrr"
  ) |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped")
  ) |&gt;
  column_spec(1, width = "10em", monospace = TRUE) |&gt;
  column_spec(2:5, width = "5em")
    </input>
  </program>
</listing>

<table xml:id="tbl-coinlow">
  <title>Linear model output predicting the total amount of money based on the number of low coins.</title>
  <tabular>
    <row header="yes">
      <cell>term</cell>
      <cell>estimate</cell>
      <cell>std.error</cell>
      <cell>statistic</cell>
      <cell>p.value</cell>
    </row>
    <row>
      <cell>(Intercept)</cell>
      <cell>2.28</cell>
      <cell>0.39</cell>
      <cell>5.89</cell>
      <cell>&lt;0.0001</cell>
    </row>
    <row>
      <cell>number_of_low_coins</cell>
      <cell>0.02</cell>
      <cell>0.03</cell>
      <cell>0.62</cell>
      <cell>0.5437</cell>
    </row>
  </tabular>
</table>

<example>
  <statement>
    <p>Come up with an example of two observations that have the same number of low coins but the number of total coins differs by one.</p>
    <p>What is the difference in total amount?</p>
  </statement>
  <solution>
    <p>Two samples of coins with the same number of low coins (3), but a different number of total coins (4 vs 5) and a different total amount ($0.41 vs $0.66).</p>
    <figure xml:id="fig-lowsame">
      <caption>Two sets of coins with same number of low coins but different total coins</caption>
      <image source="images/lowsame.png" width="45%" />
    </figure>
  </solution>
</example>

<example>
  <statement>
    <p>Come up with an example of two observations that have the same total number of coins but a different number of low coins.</p>
    <p>What is the difference in total amount?</p>
  </statement>
  <solution>
    <p>Two samples of coins with the same total number of coins (4), but a different number of low coins (3 vs 4) and a different total amount ($0.41 vs $0.17).</p>
    <figure xml:id="fig-totalsame">
      <caption>Two sets of coins with same total coins but different number of low coins</caption>
      <image source="images/totalsame.png" width="45%" />
    </figure>
  </solution>
</example>

<p>Using both the total <c>number_of_coins</c> and the <c>number_of_low_coins</c> as predictor variables, <xref ref="tbl-coinhighlow" /> provides the least squares estimates of both coefficients as 0.21 and -0.16.</p>
<p>Now, with two variables in the model, the interpretation is more nuanced.</p>

<p><ul>
  <li>A coefficient interpretation always indicates a change in one variable while keeping the other variable(s) constant. For every additional coin in the dish <alert>while</alert> the <c>number_of_low_coins</c> stays constant, we would predict that the student had US$0.21 more. Re-considering the phrase "every additional coin in the dish <alert>while</alert> the number of low coins stays constant" makes us realize that each increase is a single additional quarter (larger samples sizes would have led to a <m>b_1</m> coefficient closer to 0.25 because of the deterministic relationship described here).</li>
  <li>For every additional low coin in the dish <alert>while</alert> the total <c>number_of_coins</c> stays constant, we would predict that the student had US$0.16 less. Re-considering the phrase "every additional low coin in the dish <alert>while</alert> the number of total coins stays constant" makes us realize that a quarter is being swapped out for a penny, nickel, or dime.</li>
</ul></p>

<p>Considering the coefficients across <xref ref="tbl-coinhigh" />, <xref ref="tbl-coinlow" />, and <xref ref="tbl-coinhighlow" /> within the context and knowledge we have of US coins allows us to understand the correlation between variables and why the signs of the coefficients would change depending on the model.</p>
<p>Note also, however, that the p-value for the <c>number_of_low_coins</c> coefficient changed from <xref ref="tbl-coinlow" /> to <xref ref="tbl-coinhighlow" />.</p>
<p>It makes sense that the variable describing the <c>number_of_low_coins</c> provides more information about the <c>total_amount</c> of money when it is part of a model which also includes the total <c>number_of_coins</c> than it does when it is used as a single variable in a simple linear regression model.</p>

<md>
  <mrow>\widehat{\texttt{total\_amount}} = 0.80 \amp+ 0.21 \times \texttt{number\_of\_coins}</mrow>
  <mrow>\amp- 0.16 \times \texttt{number\_of\_low\_coins}</mrow>
</md>

<listing xml:id="listing-coinhighlow-code">
  <caption>R code for linear model with both predictors</caption>
  <program language="r">
    <input>
lm(total_amount ~ number_of_coins + number_of_low_coins, data = money) |&gt;
  tidy() |&gt;
  mutate(p.value = ifelse(p.value &lt; .0001, "&lt;0.0001", round(p.value, 4))) |&gt;
  kbl(
    linesep = "", booktabs = TRUE,
    digits = 2, align = "lrrrr"
  ) |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped")
  ) |&gt;
  column_spec(1, width = "10em", monospace = TRUE) |&gt;
  column_spec(2:5, width = "5em")
    </input>
  </program>
</listing>

<table xml:id="tbl-coinhighlow">
  <title>Linear model output predicting the total amount of money based on both the total number of coins and the number of low coins.</title>
  <tabular>
    <row header="yes">
      <cell>term</cell>
      <cell>estimate</cell>
      <cell>std.error</cell>
      <cell>statistic</cell>
      <cell>p.value</cell>
    </row>
    <row>
      <cell>(Intercept)</cell>
      <cell>0.80</cell>
      <cell>0.24</cell>
      <cell>3.38</cell>
      <cell>0.0026</cell>
    </row>
    <row>
      <cell>number_of_coins</cell>
      <cell>0.21</cell>
      <cell>0.01</cell>
      <cell>14.40</cell>
      <cell>&lt;0.0001</cell>
    </row>
    <row>
      <cell>number_of_low_coins</cell>
      <cell>-0.16</cell>
      <cell>0.02</cell>
      <cell>-8.86</cell>
      <cell>&lt;0.0001</cell>
    </row>
  </tabular>
</table>

<p>When working with multiple regression models, interpreting the model coefficients is not always as straightforward as it was with the coin example.</p>
<p>However, we encourage you to always think carefully about the variables in the model, consider how they might be correlated among themselves, and work through different models to see how using different sets of variables might produce different relationships for predicting the response variable of interest.</p>

<assemblage>
  <title>Multicollinearity</title>
  <p><alert>Multicollinearity</alert><idx>multicollinearity</idx> happens when the predictor variables are correlated within themselves.</p>
  <p>When the predictor variables themselves are correlated, the coefficients in a multiple regression model can be difficult to interpret.</p>
</assemblage>

<p>Although diving into the details are beyond the scope of this text, we will provide one more reflection about multicollinearity.</p>
<p>If the predictor variables have some degree of correlation, it can be quite difficult to interpret the value of the coefficient or evaluate whether the variable is a statistically discernible predictor of the outcome.</p>
<p>However, even a model that suffers from high multicollinearity will likely lead to unbiased predictions of the response variable.</p>
<p>So if the task at hand is only to do prediction (and not to interpret coefficients), multicollinearity is likely to not cause you substantial problems.</p>

</section>

<section xml:id="sec-inf-mult-reg-cv">
  <title>Cross-validation for prediction error</title>

<p>In <xref ref="sec-inf-mult-reg-soft" />, p-values were calculated on each of the model coefficients.</p>
<p>The p-value gives a sense of which variables are important to the model; however, a more extensive treatment of variable selection is warranted in a follow-up course or textbook.</p>
<p>Here, we use <alert>cross-validation</alert><idx>cross-validation</idx> <alert>prediction error</alert><idx>prediction error</idx> to focus on which variable(s) are important for predicting the response variable of interest.</p>
<p>In general, linear models are also used to make predictions of individual observations.</p>
<p>In addition to model building, cross-validation provides a method for generating predictions that are not overfit to the particular dataset at hand.</p>
<p>We continue to encourage you to take up further study on the topic of cross-validation, as it is among the most important ideas in modern data analysis, and we are only able to scratch the surface here.</p>

<p>Cross-validation is a computational technique which removes some observations before a model is run, then assesses the model accuracy on the held-out sample.</p>
<p>By removing some observations, we provide ourselves with an independent evaluation of the model (that is, the removed observations do not contribute to finding the parameters which minimize the least squares equation).</p>
<p>Cross-validation can be used in many different ways (as an independent assessment), and here we will just scratch the surface with respect to one way the technique can be used to compare models.</p>
<p>See <xref ref="fig-cv" /> for a visual representation of the cross-validation process.</p>

<figure xml:id="fig-cv">
  <caption>The dataset is broken into k folds (here k = 4). One at a time, a model is built using k-1 of the folds, and predictions are calculated on the single held out sample which will be completely independent of the model estimation.</caption>
  <image source="images/CV.png" width="100%" />
</figure>

<note>
  <title>Data</title>
  <p>The <url href="https://allisonhorst.github.io/palmerpenguins/articles/intro.html"><c>penguins</c></url> data can be found in the <url href="https://github.com/allisonhorst/palmerpenguins"><alert>palmerpenguins</alert></url> R package.</p>
</note>

<p>Our goal in this section is to compare two different regression models which both seek to predict the mass of an individual penguin in grams.</p>
<p>The observations of three different penguin species include measurements on body size and sex.</p>
<p>The data were collected by Dr. Kristen Gorman and the Palmer Station, Antarctica LTER as part of the Long Term Ecological Research Network.</p>
<p>Although not exactly aligned with this research project, you might be able to imagine a setting where the dimensions of the penguin are known (through, for example, aerial photographs) but the mass is not known.</p>
<p>The first model predicts <c>body_mass_g</c> by using only the <c>bill_length_mm</c>, a variable denoting the length of a penguin's bill, in mm.</p>
<p>The second model predicts <c>body_mass_g</c> by using <c>bill_length_mm</c>, <c>bill_depth_mm</c>, <c>flipper_length_mm</c>, <c>sex</c>, and <c>species</c>.</p>

<assemblage>
  <title>Prediction error</title>
  <p>The predicted error (also previously called the <alert>residual</alert>) is the difference between the observed value and the predicted value (from the regression model).</p>
  <me>\text{prediction error}_i = e_i = y_i - \hat{y}_i</me>
</assemblage>

<p>The presentation below (see the comparison of <xref ref="fig-peng-mass1" /> and <xref ref="fig-peng-mass2" />) shows that the model with more variables predicts <c>body_mass_g</c> with much smaller errors (predicted minus actual body mass) than the model which uses only <c>bill_length_g</c>.</p>
<p>We have deliberately used a model that intuitively makes sense (the more body measurements, the more predictable mass is).</p>
<p>However, in many settings, it is not obvious which variables or which models contribute most to accurate predictions.</p>
<p>Cross-validation is one way to get accurate independent predictions with which to compare different models.</p>

<subsection xml:id="comparing-two-models-to-predict-body-mass-in-penguins">
  <title>Comparing two models to predict body mass in penguins</title>

<p>The question we will seek to answer is whether the predictions of <c>body_mass_g</c> are substantially better when <c>bill_length_mm</c>, <c>bill_depth_mm</c>, <c>flipper_length_mm</c>, <c>sex</c>, and <c>species</c> are used in the model, as compared with a model on <c>bill_length_mm</c> only.</p>

<p>We refer to the model given with only <c>bill_length_mm</c> as the <alert>smaller</alert> model.</p>
<p>It is seen in <xref ref="tbl-peng-lm-bill" /> with coefficient estimates of the parameters as well as standard errors and p-values.</p>
<p>We refer to the model given with <c>bill_length_mm</c>, <c>bill_depth_mm</c>, <c>flipper_length_mm</c>, <c>sex</c>, and <c>species</c> as the <alert>larger</alert> model.</p>
<p>It is seen in <xref ref="tbl-peng-lm-all" /> with coefficient estimates of the parameters as well as standard errors and p-values.</p>
<p>Given what we know about high correlations between body measurements, it is somewhat unsurprising that all of the variables have low p-values, suggesting that each variable is a statistically discernible predictor of <c>body_mass_g</c>, given all other variables in the model.</p>
<p>However, in this section, we will go beyond the use of p-values to consider independent predictions of <c>body_mass_g</c> as a way to compare the smaller and larger models.</p>

<p><alert>The smaller model:</alert></p>

<md>
  <mrow>E[\texttt{body\_mass\_g}] \amp= \ \beta_0 + \beta_1 \times \texttt{bill\_length\_mm}</mrow>
  <mrow>\widehat{\texttt{body\_mass\_g}} \amp= \ 362.31 + 87.42 \times \texttt{bill\_length\_mm}</mrow>
</md>

<listing xml:id="listing-peng-lm-bill-code">
  <caption>R code for smaller penguin model</caption>
  <program language="r">
    <input>
lm(body_mass_g ~ bill_length_mm, data = penguins) |&gt;
  tidy() |&gt;
  mutate(p.value = ifelse(p.value &lt; .0001, "&lt;0.0001", round(p.value, 4))) |&gt;
  kbl(
    linesep = "", booktabs = TRUE,
    digits = 2, align = "lrrrr"
  ) |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped")
  ) |&gt;
  column_spec(1, width = "10em", monospace = TRUE) |&gt;
  column_spec(2:5, width = "5em")
    </input>
  </program>
</listing>

<table xml:id="tbl-peng-lm-bill">
  <title>Least squares estimates for the smaller regression model predicting <c>body_mass_g</c> from <c>bill_length_mm</c>.</title>
  <tabular>
    <row header="yes">
      <cell>term</cell>
      <cell>estimate</cell>
      <cell>std.error</cell>
      <cell>statistic</cell>
      <cell>p.value</cell>
    </row>
    <row>
      <cell>(Intercept)</cell>
      <cell>362.31</cell>
      <cell>283.35</cell>
      <cell>1.28</cell>
      <cell>0.2018</cell>
    </row>
    <row>
      <cell>bill_length_mm</cell>
      <cell>87.42</cell>
      <cell>6.40</cell>
      <cell>13.65</cell>
      <cell>&lt;0.0001</cell>
    </row>
  </tabular>
</table>

<p><alert>The larger model:</alert></p>

<md>
  <mrow>E[\texttt{body\_mass\_g}] = \beta_0 \amp+ \beta_1 \times \texttt{bill\_length\_mm}</mrow>
  <mrow>\amp+ \beta_2 \times \texttt{bill\_depth\_mm}</mrow>
  <mrow>\amp+ \beta_3 \times \texttt{flipper\_length\_mm}</mrow>
  <mrow>\amp+ \beta_4 \times \texttt{sex}\_{\text{male}}</mrow>
  <mrow>\amp+ \beta_5 \times \texttt{species}\_{\text{Chinstrap}}</mrow>
  <mrow>\amp+ \beta_6 \times \texttt{species}\_{\text{Gentoo}}</mrow>
  <mrow>\widehat{\texttt{body\_mass\_g}} = -1460.99 \amp+ 18.20 \times \texttt{bill\_length\_mm}</mrow>
  <mrow>\amp+ 67.22 \times \texttt{bill\_depth\_mm}</mrow>
  <mrow>\amp+ 15.95 \times \texttt{flipper\_length\_mm}</mrow>
  <mrow>\amp+ 389.89 \times \texttt{sex}\_{\text{male}}</mrow>
  <mrow>\amp- 251.48 \times \texttt{species}\_{\text{Chinstrap}}</mrow>
  <mrow>\amp+ 1014.63 \times \texttt{species}\_{\text{Gentoo}}</mrow>
</md>

<listing xml:id="listing-peng-lm-all-code">
  <caption>R code for larger penguin model</caption>
  <program language="r">
    <input>
lm(body_mass_g ~ bill_length_mm + bill_depth_mm + flipper_length_mm + sex + species, data = penguins) |&gt;
  tidy() |&gt;
  mutate(p.value = ifelse(p.value &lt; .0001, "&lt;0.0001", round(p.value, 4))) |&gt;
  kbl(
    linesep = "", booktabs = TRUE,
    digits = 2, align = "lrrrr"
  ) |&gt;
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped")
  ) |&gt;
  column_spec(1, width = "10em", monospace = TRUE) |&gt;
  column_spec(2:5, width = "5em")
    </input>
  </program>
</listing>

<table xml:id="tbl-peng-lm-all">
  <title>Least squares estimates of the larger regression model predicting <c>body_mass_g</c> from <c>bill_length_mm</c>, <c>bill_depth_mm</c>, <c>flipper_length_mm</c>, <c>sex</c>, and <c>species</c>.</title>
  <tabular>
    <row header="yes">
      <cell>term</cell>
      <cell>estimate</cell>
      <cell>std.error</cell>
      <cell>statistic</cell>
      <cell>p.value</cell>
    </row>
    <row>
      <cell>(Intercept)</cell>
      <cell>-1460.99</cell>
      <cell>571.53</cell>
      <cell>-2.56</cell>
      <cell>0.0111</cell>
    </row>
    <row>
      <cell>bill_length_mm</cell>
      <cell>18.20</cell>
      <cell>7.11</cell>
      <cell>2.56</cell>
      <cell>0.0109</cell>
    </row>
    <row>
      <cell>bill_depth_mm</cell>
      <cell>67.22</cell>
      <cell>19.74</cell>
      <cell>3.40</cell>
      <cell>0.0007</cell>
    </row>
    <row>
      <cell>flipper_length_mm</cell>
      <cell>15.95</cell>
      <cell>2.91</cell>
      <cell>5.48</cell>
      <cell>&lt;0.0001</cell>
    </row>
    <row>
      <cell>sexmale</cell>
      <cell>389.89</cell>
      <cell>47.85</cell>
      <cell>8.15</cell>
      <cell>&lt;0.0001</cell>
    </row>
    <row>
      <cell>speciesChinstrap</cell>
      <cell>-251.48</cell>
      <cell>81.08</cell>
      <cell>-3.10</cell>
      <cell>0.0021</cell>
    </row>
    <row>
      <cell>speciesGentoo</cell>
      <cell>1014.63</cell>
      <cell>129.56</cell>
      <cell>7.83</cell>
      <cell>&lt;0.0001</cell>
    </row>
  </tabular>
</table>

<p>In order to compare the smaller and larger models in terms of their <alert>ability to predict penguin mass</alert>, we need to build models that can provide independent predictions based on the penguins in the holdout samples created by cross-validation.</p>
<p>To reiterate, each of the predictions that (when combined together) will allow us to distinguish between the smaller and larger are independent of the data which were used to build the model.</p>
<p>In this example, using cross-validation, we remove one quarter of the data before running the least squares calculations.</p>
<p>Then the least squares model is used to predict the <c>body_mass_g</c> of the penguins in the holdout sample.</p>
<p>Here we use a 4-fold cross-validation (meaning that one quarter of the data is removed each time) to produce four different versions of each model (other times it might be more appropriate to use 2-fold or 10-fold or even run the model separately after removing each individual data point one at a time).</p>

<p><xref ref="fig-massCV1" /> displays how a model is fit to 3/4 of the data (note the slight differences in coefficients as compared to <xref ref="tbl-peng-lm-bill" />), and then predictions are made on the holdout sample.</p>

<figure xml:id="fig-massCV1">
  <caption>The smaller model. The coefficients are estimated using the least squares model on 3/4 of the dataset with only a single predictor variable. Predictions are made on the remaining 1/4 of the observations. The y-axis in the scatterplot represents the residual, true observed value minus the predicted value. Note that the predictions are independent of the estimated model coefficients.</caption>
  <image source="images/massCV1.png" width="90%" />
</figure>

<p>By repeating the process for each holdout quarter sample, the residuals from the model can be plotted against the predicted values.</p>
<p>We see that the predictions are scattered which shows a good model fit but that the prediction errors vary <m>\pm</m> 1,000 g of the true body mass.</p>

<listing xml:id="listing-peng-mass1-code">
  <caption>R code for cross-validation with smaller model</caption>
  <program language="r">
    <input>
set.seed(47)
penguins &lt;- penguins |&gt; na.omit()

penguinfolds &lt;- caret::createFolds(penguins$body_mass_g, k = 4)

data.frame(
  predicted = lm(body_mass_g ~ bill_length_mm, data = penguins[-penguinfolds$Fold1, ]) |&gt;
    predict(newdata = penguins[penguinfolds$Fold1, c("bill_length_mm")]),
  obs = penguins[penguinfolds$Fold1, ]$body_mass_g,
  fold = rep("1st quarter", length(penguinfolds$Fold1))
) |&gt;
  rbind(data.frame(
    predicted = lm(body_mass_g ~ bill_length_mm, data = penguins[-penguinfolds$Fold2, ]) |&gt;
      predict(newdata = penguins[penguinfolds$Fold2, c("bill_length_mm")]),
    obs = penguins[penguinfolds$Fold2, ]$body_mass_g,
    fold = rep("2nd quarter", length(penguinfolds$Fold2))
  )) |&gt;
  rbind(data.frame(
    predicted = lm(body_mass_g ~ bill_length_mm, data = penguins[-penguinfolds$Fold3, ]) |&gt;
      predict(newdata = penguins[penguinfolds$Fold3, c("bill_length_mm")]),
    obs = penguins[penguinfolds$Fold3, ]$body_mass_g,
    fold = rep("3rd quarter", length(penguinfolds$Fold3))
  )) |&gt;
  rbind(data.frame(
    predicted = lm(body_mass_g ~ bill_length_mm, data = penguins[-penguinfolds$Fold4, ]) |&gt;
      predict(newdata = penguins[penguinfolds$Fold4, c("bill_length_mm")]),
    obs = penguins[penguinfolds$Fold4, ]$body_mass_g,
    fold = rep("4th quarter", length(penguinfolds$Fold4))
  )) |&gt;
  mutate(error = obs - predicted) |&gt;
  ggplot(aes(x = predicted, y = error)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 500, lty = 2, color = "grey") +
  geom_hline(yintercept = -500, lty = 2, color = "grey") +
  facet_wrap(~fold) +
  ylim(c(-1000, 1000)) +
  labs(
    x = "Predicted body mass (g)",
    y = "Prediction error (g)"
  )
    </input>
  </program>
</listing>

<figure xml:id="fig-peng-mass1">
  <caption>The smaller model. One quarter at a time, the data were removed from the model building, and the body mass of the removed penguins was predicted. The least squares regression model was fit independently of the removed penguins. The predictions of body mass are based on bill length only. The x-axis represents the predicted value, the y-axis represents the error, the difference between predicted value and actual value.</caption>
  <image source="images/fig-peng-mass1-1.png" width="100%" />
</figure>

<p>The cross-validation SSE is the sum of squared error associated with the predictions.</p>
<p>Let <m>\hat{y}_{cv,i}</m> be the prediction for the <m>i^{th}</m> observation where the <m>i^{th}</m> observation was in the hold-out fold and the other three folds were used to create the linear model.</p>
<p>For the model using only <c>bill_length_mm</c> to predict <c>body_mass_g</c>, the CV SSE is 141,552,822.</p>

<assemblage>
  <title>Cross-validation SSE</title>
  <p>The prediction error from the cross-validated model can be used to calculate a single numerical summary of the model.</p>
  <p>The cross-validation SSE is the sum of squared cross-validation prediction errors.</p>
  <me>\mbox{CV SSE} = \sum_{i=1}^n (\hat{y}_{cv,i} - y_i)^2</me>
</assemblage>

<p>The same process is repeated for the larger number of explanatory variables.</p>
<p>Note that the coefficients estimated for the first cross-validation model (in <xref ref="fig-massCV2" />) are slightly different from the estimates computed on the entire dataset (seen in <xref ref="tbl-peng-lm-all" />).</p>
<p><xref ref="fig-massCV2" /> displays the cross-validation process for the multivariable model with a full set of residual plots given in <xref ref="fig-peng-mass2" />.</p>
<p>Note that the residuals are mostly within <m>\pm</m> 500g, providing much more precise predictions for the independent body mass values of the individual penguins.</p>

<figure xml:id="fig-massCV2">
  <caption>The larger model. The coefficients are estimated using the least squares model on 3/4 of the dataset with the five specified predictor variables. Predictions are made on the remaining 1/4 of the observations. The y-axis in the scatterplot represents the residual, true observed value minus the predicted value. Note that the predictions are independent of the estimated model coefficients.</caption>
  <image source="images/massCV2.png" width="90%" />
</figure>

<listing xml:id="listing-peng-mass2-code">
  <caption>R code for cross-validation with larger model</caption>
  <program language="r">
    <input>
data.frame(
  predicted = lm(body_mass_g ~ bill_length_mm + bill_depth_mm + flipper_length_mm + sex + species, data = penguins[-penguinfolds$Fold1, ]) |&gt;
    predict(newdata = penguins[penguinfolds$Fold1, c("bill_length_mm", "bill_depth_mm", "flipper_length_mm", "sex", "species")]),
  obs = penguins[penguinfolds$Fold1, ]$body_mass_g,
  fold = rep("1st quarter", length(penguinfolds$Fold1))
) |&gt;
  rbind(data.frame(
    predicted = lm(body_mass_g ~ bill_length_mm + bill_depth_mm + flipper_length_mm + sex + species, data = penguins[-penguinfolds$Fold2, ]) |&gt;
      predict(newdata = penguins[penguinfolds$Fold2, c("bill_length_mm", "bill_depth_mm", "flipper_length_mm", "sex", "species")]),
    obs = penguins[penguinfolds$Fold2, ]$body_mass_g,
    fold = rep("2nd quarter", length(penguinfolds$Fold2))
  )) |&gt;
  rbind(data.frame(
    predicted = lm(body_mass_g ~ bill_length_mm + bill_depth_mm + flipper_length_mm + sex + species, data = penguins[-penguinfolds$Fold3, ]) |&gt;
      predict(newdata = penguins[penguinfolds$Fold3, c("bill_length_mm", "bill_depth_mm", "flipper_length_mm", "sex", "species")]),
    obs = penguins[penguinfolds$Fold3, ]$body_mass_g,
    fold = rep("3rd quarter", length(penguinfolds$Fold3))
  )) |&gt;
  rbind(data.frame(
    predicted = lm(body_mass_g ~ bill_length_mm + bill_depth_mm + flipper_length_mm + sex + species, data = penguins[-penguinfolds$Fold4, ]) |&gt;
      predict(newdata = penguins[penguinfolds$Fold4, c("bill_length_mm", "bill_depth_mm", "flipper_length_mm", "sex", "species")]),
    obs = penguins[penguinfolds$Fold4, ]$body_mass_g,
    fold = rep("4th quarter", length(penguinfolds$Fold4))
  )) |&gt;
  mutate(error = obs - predicted) |&gt;
  ggplot(aes(x = predicted, y = error)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 500, lty = 2, color = "grey") +
  geom_hline(yintercept = -500, lty = 2, color = "grey") +
  facet_wrap(~fold) +
  ylim(c(-1000, 1000)) +
  labs(
    x = "Predicted body mass (g)",
    y = "Prediction error (g)"
  )
    </input>
  </program>
</listing>

<figure xml:id="fig-peng-mass2">
  <caption>The larger model. One quarter at a time, the data were removed from the model building, and the body mass of the removed penguins was predicted. The least squares regression model was fit independently of the removed penguins. The predictions of body mass are based on the set of five variables described in <xref ref="tbl-peng-lm-all" />. The x-axis represents the predicted value, the y-axis represents the error, the difference between predicted value and actual value.</caption>
  <image source="images/fig-peng-mass2-1.png" width="100%" />
</figure>

<p><xref ref="fig-peng-mass1" /> shows that the independent predictions are centered around the true values (i.e., errors are centered around zero), but that the predictions can be as much as 1,000 g off when using only <c>bill_length_mm</c> to predict <c>body_mass_g</c>.</p>
<p>On the other hand, when using <c>bill_length_mm</c>, <c>bill_depth_mm</c>, <c>flipper_length_mm</c>, <c>sex</c>, and <c>species</c> to predict <c>body_mass_g</c>, the prediction errors seem to be about half as big, as seen in <xref ref="fig-peng-mass2" />.</p>
<p>For the model using <c>bill_length_mm</c>, <c>bill_depth_mm</c>, <c>flipper_length_mm</c>, <c>sex</c>, and <c>species</c> to predict <c>body_mass_g</c>, the CV SSE is 27,728,698 (as compared to a CV SSE of 141,552,822 for the smaller model).</p>
<p>Consistent with visually comparing the two sets of residual plots, the sum of squared prediction errors is smaller for the model which uses more predictor variables.</p>
<p>The model with more predictor variables seems like the better model (according to the cross-validated prediction errors criteria).</p>

<p>We have provided a very brief overview to and example of using cross-validation.</p>
<p>Cross-validation is a computational approach to model building and model validation as an alternative to reliance on p-values.</p>
<p>While p-values have a role to play in understanding model coefficients, throughout this text, we have continued to present computational methods that broaden statistical approaches to data analysis.</p>
<p>Cross-validation will be used again in <xref ref="ch26-inference-logistic-regression" /> with logistic regression.</p>
<p>We encourage you to consider both standard inferential methods (such as p-values) and computational approaches (such as cross-validation) as you build and use multivariable models of all varieties.</p>

</subsection>

</section>

<section xml:id="sec-chp25-review">
  <title>Chapter review</title>

<subsection xml:id="sec-chp25-summary">
  <title>Summary</title>

<p>Building on the modeling ideas from <xref ref="sec-model-mlr" />, we have now introduced methods for evaluating coefficients (based on p-values) and evaluating models (cross-validation).</p>
<p>There are many important aspects to consider when working with multiple variables in a single model, and we have only glanced at a few topics.</p>
<p>Remember, multicollinearity can make coefficient interpretation difficult.</p>
<p>A topic not covered in this text but important for multiple regression models is interaction, and we hope that you learn more about how variables work together as you continue to build up your modeling skills.</p>

</subsection>

<subsection xml:id="sec-chp25-terms">
  <title>Terms</title>

<p>The terms introduced in this chapter are presented in <xref ref="tbl-terms-chp-25" />.</p>
<p>If you're not sure what some of these terms mean, we recommend you go back in the text and review their definitions.</p>
<p>You should be able to easily spot them as <alert>bolded text</alert>.</p>

<table xml:id="tbl-terms-chp-25">
  <title>Terms introduced in this chapter.</title>
  <tabular>
    <row>
      <cell>inference on multiple linear regression</cell>
    </row>
    <row>
      <cell>predictor</cell>
    </row>
    <row>
      <cell>multiple predictors</cell>
    </row>
    <row>
      <cell>multicollinearity</cell>
    </row>
    <row>
      <cell>cross-validation</cell>
    </row>
    <row>
      <cell>prediction error</cell>
    </row>
  </tabular>
</table>

</subsection>

</section>

<section xml:id="sec-chp25-exercises">
  <title>Exercises</title>

<p>Answers to odd-numbered exercises can be found in <xref ref="appendix-exercise-solutions">Appendix</xref>.</p>

<xi:include href="../exercises/_25-ex-inf-model-mlr.ptx" />

</section>

</chapter>
